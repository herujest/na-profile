# Multi-stage build for development
# Stage 1: Dependencies
# Using node:18-slim instead of alpine for better Prisma binary compatibility
FROM node:18-slim AS deps
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*
WORKDIR /app

# Copy package files
COPY package.json yarn.lock* package-lock.json* ./

# Install dependencies (skip postinstall scripts - we'll run prisma generate separately)
RUN \
  if [ -f yarn.lock ]; then yarn --frozen-lockfile --ignore-scripts; \
  elif [ -f package-lock.json ]; then npm ci --ignore-scripts; \
  else echo "Lockfile not found." && exit 1; \
  fi

# Copy Prisma schema
COPY prisma ./prisma
ENV DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy?schema=public"
# Try to generate Prisma Client in deps stage (non-fatal)
# If it fails, we'll try again in builder stage
RUN npx prisma generate --schema=./prisma/schema.prisma || \
    (echo "⚠️  Prisma generation failed in deps stage, will retry in builder" && exit 0)

# Stage 2: Builder
# Using node:18-slim instead of alpine for better Prisma binary compatibility
FROM node:18-slim AS builder
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*
WORKDIR /app

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules

# Copy Prisma schema first
COPY prisma ./prisma

# Copy the rest of the application
COPY . .

# Set environment variables for build (development)
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_ENV=development
# Provide a dummy DATABASE_URL during build to allow Prisma Client to initialize
# The actual DATABASE_URL will be provided at runtime via .env.development
ENV DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy?schema=public"

# Generate Prisma Client (required for Next.js build)
# Try multiple methods to avoid the assertion error
RUN if [ ! -d "node_modules/.prisma" ]; then \
      echo "Prisma Client not found, generating..." && \
      (npx prisma generate --schema=./prisma/schema.prisma || \
       yarn prisma generate --schema=./prisma/schema.prisma || \
       (echo "⚠️  Both npm and yarn failed, trying with explicit binary target" && \
        PRISMA_CLI_BINARY_TARGETS=debian-openssl-3.0.x npx prisma generate --schema=./prisma/schema.prisma)); \
    else \
      echo "Prisma Client already generated, skipping..."; \
    fi

# Build Next.js application for development
RUN npm run build || yarn build

# Stage 3: Runner (Development)
# Using node:18-slim instead of alpine for better Prisma binary compatibility
FROM node:18-slim AS runner
# Accept build version as build argument
ARG BUILD_VERSION
LABEL version="${BUILD_VERSION}"
LABEL environment="development"

WORKDIR /app

ENV NODE_ENV=development
ENV NEXT_TELEMETRY_DISABLED=1

# Install curl and openssl for healthcheck and Prisma
RUN apt-get update && apt-get install -y \
    curl \
    openssl \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user (Debian uses different commands than Alpine)
RUN groupadd --system --gid 1001 nodejs && \
    useradd --system --uid 1001 --gid nodejs --shell /bin/bash nextjs

# Copy standalone build from builder (includes minimal server and dependencies)
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
# Copy static files
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# Copy public folder
COPY --from=builder --chown=nextjs:nodejs /app/public ./public

# Copy additional runtime files needed
COPY --from=builder --chown=nextjs:nodejs /app/styles ./styles
COPY --from=builder --chown=nextjs:nodejs /app/lib/data ./lib/data
COPY --from=builder --chown=nextjs:nodejs /app/app/content ./app/content
COPY --from=builder --chown=nextjs:nodejs /app/assets ./assets
COPY --from=builder --chown=nextjs:nodejs /app/webpack ./webpack

# Copy Prisma files
COPY --from=builder --chown=nextjs:nodejs /app/node_modules/.prisma ./node_modules/.prisma
COPY --from=builder --chown=nextjs:nodejs /app/node_modules/@prisma ./node_modules/@prisma
COPY --from=builder --chown=nextjs:nodejs /app/prisma ./prisma

# Copy startup script
COPY --from=builder --chown=nextjs:nodejs /app/scripts/start.sh ./scripts/start.sh
RUN chmod +x ./scripts/start.sh

USER nextjs

EXPOSE 3001

ENV PORT=3001
ENV HOSTNAME="0.0.0.0"

# Run migrations and start the app using startup script
CMD ["./scripts/start.sh"]

