# Multi-stage build for development
# Stage 1: Dependencies
# Using node:18-slim instead of alpine for better Prisma binary compatibility
FROM node:18-slim AS deps
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*
WORKDIR /app

# Copy package files
COPY package.json yarn.lock* package-lock.json* ./

# Install dependencies (skip postinstall scripts - we'll run prisma generate separately)
RUN \
  if [ -f yarn.lock ]; then yarn --frozen-lockfile --ignore-scripts; \
  elif [ -f package-lock.json ]; then npm ci --ignore-scripts; \
  else echo "Lockfile not found." && exit 1; \
  fi

# Copy Prisma schema
COPY prisma ./prisma
# Accept DATABASE_URL as build argument (with default dummy value for Prisma Client generation)
ARG DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy?schema=public"
ENV DATABASE_URL=${DATABASE_URL}
# Try to generate Prisma Client in deps stage (non-fatal)
# If it fails, we'll try again in builder stage
RUN npx prisma generate --schema=./prisma/schema.prisma || \
    (echo "⚠️  Prisma generation failed in deps stage, will retry in builder" && exit 0)

# Stage 2: Builder
# Using node:18-slim instead of alpine for better Prisma binary compatibility
FROM node:18-slim AS builder
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*
WORKDIR /app

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules

# Copy Prisma schema first
COPY prisma ./prisma

# Copy the rest of the application
COPY . .

# Set environment variables for build (development)
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_ENV=development
# Accept DATABASE_URL as build argument (with default dummy value for Prisma Client generation)
# The actual DATABASE_URL will be provided at runtime via .env.development or docker-compose
ARG DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy?schema=public"
ENV DATABASE_URL=${DATABASE_URL}

# Generate Prisma Client (required for Next.js build)
# Try multiple methods to avoid the assertion error
RUN if [ ! -d "node_modules/.prisma" ]; then \
      echo "Prisma Client not found, generating..." && \
      (npx prisma generate --schema=./prisma/schema.prisma || \
       yarn prisma generate --schema=./prisma/schema.prisma || \
       (echo "⚠️  Both npm and yarn failed, trying with explicit binary target" && \
        PRISMA_CLI_BINARY_TARGETS=debian-openssl-3.0.x npx prisma generate --schema=./prisma/schema.prisma)); \
    else \
      echo "Prisma Client already generated, skipping..."; \
    fi

# Build Next.js application for development
# Use a script to handle build errors gracefully and ensure output is generated
RUN chmod +x scripts/build-with-errors.sh && \
    bash scripts/build-with-errors.sh

# Stage 3: Runner (Development)
# Using node:18-slim instead of alpine for better Prisma binary compatibility
FROM node:18-slim AS runner
# Accept build version as build argument
ARG BUILD_VERSION
LABEL version="${BUILD_VERSION}"
LABEL environment="development"

WORKDIR /app

ENV NODE_ENV=development
ENV NEXT_TELEMETRY_DISABLED=1

# Install curl and openssl for healthcheck and Prisma
RUN apt-get update && apt-get install -y \
    curl \
    openssl \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user (Debian uses different commands than Alpine)
RUN groupadd --system --gid 1001 nodejs && \
    useradd --system --uid 1001 --gid nodejs --shell /bin/bash nextjs

# Copy .next directory from builder (we'll handle standalone structure in RUN)
COPY --from=builder --chown=nextjs:nodejs /app/.next ./.next-builder
# Copy static files separately
RUN if [ -d ".next-builder/static" ]; then \
      mkdir -p .next/static && \
      cp -r .next-builder/static/* .next/static/; \
    fi
# Handle standalone structure - create it if it doesn't exist
RUN if [ -d ".next-builder/standalone" ]; then \
      cp -r .next-builder/standalone .; \
      echo "✅ Standalone structure copied"; \
    elif [ -d ".next-builder/server" ]; then \
      echo "⚠️  Standalone not found, creating from server files..."; \
      mkdir -p standalone/app; \
      cp -r .next-builder/server standalone/app/; \
      if [ -d ".next-builder/static" ]; then \
        mkdir -p standalone/app/static && \
        cp -r .next-builder/static/* standalone/app/static/; \
      fi; \
      echo "✅ Standalone structure created from server files"; \
    else \
      echo "❌ No server or standalone directory found in build output"; \
      exit 1; \
    fi && \
    rm -rf .next-builder

# Copy public folder
COPY --from=builder --chown=nextjs:nodejs /app/public ./public

# Copy additional runtime files needed
COPY --from=builder --chown=nextjs:nodejs /app/styles ./styles
COPY --from=builder --chown=nextjs:nodejs /app/lib/data ./lib/data
COPY --from=builder --chown=nextjs:nodejs /app/app/content ./app/content
COPY --from=builder --chown=nextjs:nodejs /app/assets ./assets
COPY --from=builder --chown=nextjs:nodejs /app/webpack ./webpack

# Copy Prisma files
COPY --from=builder --chown=nextjs:nodejs /app/node_modules/.prisma ./node_modules/.prisma
COPY --from=builder --chown=nextjs:nodejs /app/node_modules/@prisma ./node_modules/@prisma
COPY --from=builder --chown=nextjs:nodejs /app/prisma ./prisma

# Copy startup script
COPY --from=builder --chown=nextjs:nodejs /app/scripts/start.sh ./scripts/start.sh
RUN chmod +x ./scripts/start.sh

USER nextjs

EXPOSE 3001

ENV PORT=3001
ENV HOSTNAME="0.0.0.0"

# Run migrations and start the app using startup script
CMD ["./scripts/start.sh"]

